<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nebula Mixing Lab: Manual Override</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #02040a;
            touch-action: none; font-family: 'Inter', system-ui, sans-serif;
            color: white;
        }
        canvas { display: block; }
        .ui-overlay { pointer-events: none; z-index: 10; }
        .interactive { pointer-events: auto; }
        .glass {
            background: rgba(10, 15, 30, 0.85);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        #sideMenu {
            transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            transform: translateX(100%);
        }
        #sideMenu.open { transform: translateX(0); }
        
        input[type=range] {
            cursor: pointer;
            height: 6px;
            -webkit-appearance: none;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: #6366f1;
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.6);
            border: 2px solid white;
        }
        .control-group {
            border-bottom: 1px solid rgba(255,255,255,0.05);
            padding-bottom: 1rem;
        }
        .btn-active {
            background: rgba(99, 102, 241, 0.2);
            border-color: rgba(99, 102, 241, 0.5);
            color: #818cf8;
        }
    </style>
</head>
<body>

    <div class="fixed inset-0 ui-overlay flex flex-col justify-between p-6">
        <div class="flex justify-between items-start">
            <div class="glass p-5 rounded-3xl min-w-[200px] shadow-2xl">
                <h1 class="text-white text-lg font-medium tracking-tight italic">Manual <span class="text-indigo-400 font-bold">Override</span></h1>
                <div class="grid grid-cols-2 gap-2 mt-2">
                    <div class="text-[8px] text-white/40 uppercase font-bold tracking-widest">Units: <span id="countDisplay" class="text-indigo-300">0</span></div>
                    <div class="text-[8px] text-white/40 uppercase font-bold tracking-widest">Perf: <span id="fpsDisplay" class="text-indigo-300">60</span></div>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button id="exportBtn" class="interactive glass p-4 rounded-2xl active:scale-90 transition-transform flex items-center gap-2 group">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    <span class="text-[10px] uppercase font-bold text-white opacity-0 group-hover:opacity-100 transition-opacity">Export Lab</span>
                </button>
                <button id="menuToggle" class="interactive glass p-4 rounded-2xl active:scale-90 transition-transform">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                </button>
            </div>
        </div>
    </div>

    <div id="sideMenu" class="fixed top-0 right-0 h-full w-80 glass z-20 p-8 flex flex-col gap-4 interactive shadow-2xl overflow-y-auto">
        <div class="flex justify-between items-center mb-2">
            <h2 class="text-white text-xs font-bold uppercase tracking-[0.2em] text-indigo-400">Physics Engine</h2>
            <button id="menuClose" class="text-slate-400 hover:text-white p-2">âœ•</button>
        </div>

        <div class="space-y-5">
            <div class="control-group">
                <label class="flex justify-between text-[10px] font-bold uppercase tracking-wider text-slate-400 mb-2">
                    Internal Velocity <span><span id="speedVal">1.5</span>x</span>
                </label>
                <input type="range" id="speedRange" min="0" max="15" step="0.1" value="1.5" class="w-full">
            </div>

            <div class="control-group">
                <label class="flex justify-between text-[10px] font-bold uppercase tracking-wider text-slate-400 mb-2">
                    Interaction Force <span><span id="forceVal">2.0</span>x</span>
                </label>
                <input type="range" id="forceRange" min="0" max="20" step="0.5" value="2.0" class="w-full">
            </div>

            <div class="control-group">
                <label class="flex justify-between text-[10px] font-bold uppercase tracking-wider text-slate-400 mb-2">
                    Density (Count) <span><span id="densityVal">3000</span></span>
                </label>
                <input type="range" id="densityRange" min="500" max="10000" step="100" value="3000" class="w-full">
            </div>

            <div class="control-group">
                <label class="flex justify-between text-[10px] font-bold uppercase tracking-wider text-slate-400 mb-2">
                    Viscosity <span><span id="viscVal">0.97</span></span>
                </label>
                <input type="range" id="viscRange" min="0.80" max="1.00" step="0.01" value="0.97" class="w-full">
            </div>

            <div class="control-group">
                <label class="flex justify-between text-[10px] font-bold uppercase tracking-wider text-slate-400 mb-2">
                    Mix Persistence <span><span id="trailVal">0.15</span></span>
                </label>
                <input type="range" id="trailRange" min="0.01" max="1.00" step="0.01" value="0.15" class="w-full">
            </div>

            <div>
                <span class="text-slate-400 text-[10px] font-bold uppercase tracking-wider">Physics Mode</span>
                <div class="grid grid-cols-2 gap-2 mt-2" id="modeGrid">
                    <button class="mode-btn interactive bg-slate-800 text-slate-400 text-[10px] py-2 rounded-lg border border-transparent transition-all" data-mode="swirl">Vortex</button>
                    <button class="mode-btn interactive bg-slate-800 text-slate-400 text-[10px] py-2 rounded-lg border border-transparent transition-all" data-mode="diffuse">Burst</button>
                    <button class="mode-btn interactive bg-slate-800 text-slate-400 text-[10px] py-2 rounded-lg border border-transparent transition-all" data-mode="attract">Gravity</button>
                    <button class="mode-btn interactive bg-slate-800 text-slate-400 text-[10px] py-2 rounded-lg border border-transparent transition-all" data-mode="none">None</button>
                </div>
            </div>

            <div id="paletteList" class="space-y-2"></div>
        </div>

        <div class="mt-6 flex flex-col gap-2">
            <button id="resetEvo" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white text-[10px] font-bold uppercase py-4 rounded-xl transition-all shadow-lg shadow-indigo-500/20 active:scale-95">Reinitialize Grid</button>
        </div>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { alpha: false });
        const sideMenu = document.getElementById('sideMenu');
        const fpsDisplay = document.getElementById('fpsDisplay');
        const countDisplay = document.getElementById('countDisplay');
        
        let width, height;
        let particles = [];
        let mouse = { x: -1000, y: -1000, active: false };
        let lastTime = 0;
        
        const settings = {
            count: 3000,
            viscosity: 0.97,
            baseSpeed: 1.5,
            interactionForce: 2.0,
            trail: 0.15,
            mode: 'swirl',
            palettes: [
                ['#4f46e5', '#818cf8', '#c7d2fe', '#ffffff'],
                ['#06b6d4', '#22d3ee', '#a5f3fc', '#ffffff'],
                ['#f43f5e', '#fb7185', '#fff1f2', '#fda4af'],
                ['#8b5cf6', '#a78bfa', '#ede9fe', '#c4b5fd'],
                ['#10b981', '#34d399', '#ecfdf5', '#a7f3d0']
            ],
            activePalette: 0
        };

        class Particle {
            constructor() {
                this.init();
            }
            init() {
                this.x = Math.random() * width;
                this.y = Math.random() * height;
                this.vx = (Math.random() - 0.5) * settings.baseSpeed * 5;
                this.vy = (Math.random() - 0.5) * settings.baseSpeed * 5;
                this.size = 1 + Math.random() * 2;
                this.colorIdx = Math.floor(Math.random() * 4);
                this.updateColor();
            }
            updateColor() {
                this.color = settings.palettes[settings.activePalette][this.colorIdx];
            }
            update() {
                if (mouse.active) {
                    const dx = mouse.x - this.x;
                    const dy = mouse.y - this.y;
                    const distSq = dx * dx + dy * dy;
                    if (distSq < 100000) {
                        const dist = Math.sqrt(distSq);
                        const force = ((316 - dist) / 500) * settings.interactionForce;
                        const angle = Math.atan2(dy, dx);
                        switch(settings.mode) {
                            case 'swirl':
                                this.vx += Math.cos(angle + Math.PI/2) * force;
                                this.vy += Math.sin(angle + Math.PI/2) * force;
                                break;
                            case 'diffuse':
                                this.vx -= Math.cos(angle) * force * 1.5;
                                this.vy -= Math.sin(angle) * force * 1.5;
                                break;
                            case 'attract':
                                this.vx += Math.cos(angle) * force;
                                this.vy += Math.sin(angle) * force;
                                break;
                        }
                    }
                }
                this.vx *= settings.viscosity;
                this.vy *= settings.viscosity;
                this.vx += (Math.random() - 0.5) * 0.1 * settings.baseSpeed;
                this.vy += (Math.random() - 0.5) * 0.1 * settings.baseSpeed;
                this.x += this.vx;
                this.y += this.vy;
                if (this.x < 0) this.x = width;
                if (this.x > width) this.x = 0;
                if (this.y < 0) this.y = height;
                if (this.y > height) this.y = 0;
            }
            draw() {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.size, this.size);
            }
        }

        function setup() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            particles = [];
            for (let i = 0; i < settings.count; i++) particles.push(new Particle());
            countDisplay.innerText = settings.count;

            // UI Mode buttons
            document.querySelectorAll('.mode-btn').forEach(btn => {
                if(btn.dataset.mode === settings.mode) btn.classList.add('btn-active');
                else btn.classList.remove('btn-active');
            });

            // Palettes
            const list = document.getElementById('paletteList');
            list.innerHTML = '<span class="text-slate-400 text-[10px] font-bold uppercase tracking-wider">Color Profiles</span>';
            const grid = document.createElement('div');
            grid.className = "grid grid-cols-2 gap-2 mt-2";
            settings.palettes.forEach((pal, i) => {
                const btn = document.createElement('button');
                btn.className = `h-8 rounded-lg flex overflow-hidden border-2 transition-all ${i === settings.activePalette ? 'border-indigo-500 scale-105 shadow-lg' : 'border-transparent opacity-60 hover:opacity-100'}`;
                pal.forEach(c => {
                    const d = document.createElement('div');
                    d.style.flex = "1"; d.style.background = c;
                    btn.appendChild(d);
                });
                btn.onclick = () => {
                    settings.activePalette = i;
                    particles.forEach(p => p.updateColor());
                    setup();
                };
                grid.appendChild(btn);
            });
            list.appendChild(grid);
        }

        function animate(timestamp) {
            const dt = timestamp - lastTime;
            lastTime = timestamp;
            if (dt > 0) fpsDisplay.innerText = Math.round(1000 / dt);
            ctx.fillStyle = `rgba(2, 4, 10, ${settings.trail})`;
            ctx.fillRect(0, 0, width, height);
            for (let p of particles) {
                p.update();
                p.draw();
            }
            requestAnimationFrame(animate);
        }

        // Export Functionality
        document.getElementById('exportBtn').onclick = () => {
            const htmlContent = document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'nebula_mixing_lab_export.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        document.getElementById('menuToggle').onclick = () => sideMenu.classList.add('open');
        document.getElementById('menuClose').onclick = () => sideMenu.classList.remove('open');
        
        const updateVal = (id, val) => document.getElementById(id).innerText = val;
        document.getElementById('speedRange').oninput = (e) => {
            settings.baseSpeed = parseFloat(e.target.value);
            updateVal('speedVal', settings.baseSpeed.toFixed(1));
        };
        document.getElementById('forceRange').oninput = (e) => {
            settings.interactionForce = parseFloat(e.target.value);
            updateVal('forceVal', settings.interactionForce.toFixed(1));
        };
        document.getElementById('densityRange').oninput = (e) => {
            settings.count = parseInt(e.target.value);
            updateVal('densityVal', settings.count);
        };
        document.getElementById('viscRange').oninput = (e) => {
            settings.viscosity = parseFloat(e.target.value);
            updateVal('viscVal', settings.viscosity.toFixed(2));
        };
        document.getElementById('trailRange').oninput = (e) => {
            settings.trail = parseFloat(e.target.value);
            updateVal('trailVal', settings.trail.toFixed(2));
        };
        document.getElementById('resetEvo').onclick = () => setup();

        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.onclick = () => {
                settings.mode = btn.dataset.mode;
                setup();
            };
        });

        const handleMove = (e) => {
            const p = e.touches ? e.touches[0] : e;
            mouse.x = p.clientX;
            mouse.y = p.clientY;
        };

        window.addEventListener('mousedown', () => mouse.active = true);
        window.addEventListener('mouseup', () => mouse.active = false);
        window.addEventListener('mousemove', handleMove);
        window.addEventListener('touchstart', (e) => { mouse.active = true; handleMove(e); });
        window.addEventListener('touchmove', (e) => { handleMove(e); e.preventDefault(); }, {passive: false});
        window.addEventListener('touchend', () => mouse.active = false);
        window.addEventListener('resize', setup);

        window.onload = () => { setup(); animate(0); };
    </script>
</body>
</html>

